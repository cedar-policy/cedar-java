name: Build & Test (CedarJava & CedarJavaFFI)

on:
  pull_request:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build FFI and Java
    runs-on: ubuntu-latest
    steps:
      - name: Checkout cedar-java
        uses: actions/checkout@v4
      - name: Checkout cedar
        uses: actions/checkout@v4
        with:
          repository: cedar-policy/cedar
          ref: main
          path: /home/runner/work/cedar-java/cedar-java/cedar
      - name: Prepare Rust Build
        run: rustup update stable && rustup default stable
      - name: Check FFI Formatting
        working-directory: ./CedarJavaFFI
        run: cargo fmt --all --check
      - name: Install Zig
        run: sudo snap install zig --beta --classic
      - name: Build FFI and Java Libraries
        working-directory: ./CedarJava
        env:
          MUST_RUN_CEDAR_INTEGRATION_TESTS: 1
          CEDAR_INTEGRATION_TESTS_ROOT: /home/runner/work/cedar-java/cedar-java/cedar/cedar-integration-tests
        run: ./gradlew build
      - name: Generate Java Documentation
        working-directory: ./CedarJava
        run: ./gradlew javadoc
